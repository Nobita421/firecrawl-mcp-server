events {}
http {
  upstream app { server 127.0.0.1:3000; }

  server {
    listen 8080;

    # Alias common typo/variant: /{apiKey}/v1|v2/see -> /sse
    location ~ ^/(?<apikey>[^/]+)/v(?:1|2)/see$ {
      proxy_set_header X-Firecrawl-API-Key $apikey;
      proxy_set_header Host $host;

      proxy_buffering off;
      proxy_read_timeout 620s;
      proxy_send_timeout 620s;

      proxy_pass http://app/sse;
    }

    # Legacy with API key and version: /{apiKey}/v1|v2/{rest}
    location ~ ^/(?<apikey>[^/]+)/v(?:1|2)/(.*)$ {
      proxy_set_header X-Firecrawl-API-Key $apikey;
      proxy_set_header Host $host;

      proxy_buffering off;
      proxy_read_timeout 620s;
      proxy_send_timeout 620s;

      proxy_pass http://app/$2;
    }

    # Legacy: /{apiKey}/{rest}
    location ~ ^/(?<apikey>[^/]+)/(.*)$ {
      proxy_set_header X-Firecrawl-API-Key $apikey;
      proxy_set_header Host $host;

      proxy_buffering off;
      proxy_read_timeout 620s;
      proxy_send_timeout 620s;

      proxy_pass http://app/$2;
    }

    # Header-based with version alias: /v1|v2/see -> /sse
    location ~ ^/v(?:1|2)/see$ {
      proxy_buffering off;
      proxy_read_timeout 620s;
      proxy_send_timeout 620s;
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-For $remote_addr;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_pass http://app/sse;
    }

    # Header-based with version: /v1|v2/{rest}
    location ~ ^/v(?:1|2)/(.*)$ {
      proxy_buffering off;
      proxy_read_timeout 620s;
      proxy_send_timeout 620s;
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-For $remote_addr;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_pass http://app/$1;
    }

    # Direct header-based paths
    location /mcp {
      proxy_buffering off;
      proxy_read_timeout 620s;
      proxy_send_timeout 620s;
      proxy_pass http://app/mcp;
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-For $remote_addr;
      proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /messages {
      proxy_buffering off;
      proxy_read_timeout 620s;
      proxy_send_timeout 620s;
      proxy_pass http://app/messages;
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-For $remote_addr;
      proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /sse {
      proxy_buffering off;
      proxy_read_timeout 620s;
      proxy_send_timeout 620s;
      proxy_pass http://app/sse;
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-For $remote_addr;
      proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /health { return 200 "ok"; }
  }
}


